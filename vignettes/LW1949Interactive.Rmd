---
output: html_document
runtime: shiny
---
```{r, echo=FALSE, include=FALSE}
# library(devtools)
# devtools::install_github("JVAdams/jvamisc")
# library(jvamisc)

# library(shinyapps)
# deployApp()

### replacement for jvamisc library, which I couldn't get to work

```

### Demonstration of LW1949

The R package **LW1949** automates the steps taken in Litchfield and Wilcoxon's (1949) manual approach to evaluating dose-effect experiments.  Letting the computer do the work saves time and yields the best fit possible using the Litchfield Wilcoxon approach (by minimizing the chi-squared statistic).

Provide information on three key input variables,

- chemical concentration or dose, 
- number tested, and 
- number affected.

```{r, echo=FALSE}
plotHeight <- reactive({
  if(length(input$lakeGroup)<2 & length(input$metricGroup)<2) {
    10
  } else {
    800
  }
})
```

```{r, echo=FALSE}
mydat <- reactive({
  conc <- c(input$dose1, input$dose2, input$dose3)
  numtested <- c(input$ntot1, input$ntot2, input$ntot3)
  numaffected <- c(input$nfx1, input$nfx2, input$nfx3)
  dataprep(dose=conc, ntot=numtested, nfx=numaffected)
})

fLW <- reactive({
  fitLW(mydat())
})

pctaffected <- reactive({
  c(input$pa1, input$pa2, input$pa3)
})



# both
predlinear(pctaffected(), fLW())

# dat
fp <- fitprobit(mydat)

# both
cbind(pctaffected, do.call(rbind, lapply(pctaffected, predprobit, fp)))

# both
plotDE(mydat)
abline(fLW$params)
abline(fp$coef, lty=2)
legend("topleft", c("LW", "Probit"), lty=1:2, bg="white")




```

```{r, echo=FALSE}
output$onePlot <- renderPlot({
  
  fLW <- fitLW(mydat)


  
  selM <- as.numeric(input$metricGroup)
  
  if (length(selM)>1 & length(selL)>1) {
    stop("\n\nNarrow your selection to only ONE LAKE or ONE METRIC.")
    }
  
  mypar <- c(4, 6, 1.5, 24)
  par(mar=mypar, cex=1.5, yaxs="i")
      
      par(new=TRUE, mar=mypar, cex=1.5, yaxs="i")
      plot(x, y, ylim=1.02*range(0, y, na.rm=TRUE), yaxt="n", type="n", 
        xlab="Spawning year", ylab="", main=Lakenames[selL])
    
}, 
  width=1000, 
  height=450,
)
```

```{r, echo=FALSE}
fluidPage(
  h4("Select", strong("ONE LAKE"), 
    "and several metrics ... or ... several lakes and", 
    strong("ONE METRIC"), "."),
  
  fluidRow(
  
    column(2, 
      numericInput("dose1", label=h4("Dose #1"), value=NA, min=0, max=Inf),
      numericInput("dose2", label=h4("Dose #2"), value=NA, min=0, max=Inf),
      numericInput("dose3", label=h4("Dose #3"), value=NA, min=0, max=Inf)
    ),
    
    column(2, 
      numericInput("ntot1", label=h4("No. tested #1"), 
        value=NA, min=1, max=Inf),
      numericInput("ntot2", label=h4("No. tested #2"), 
        value=NA, min=1, max=Inf),
      numericInput("ntot3", label=h4("No. tested #3"), 
        value=NA, min=1, max=Inf)
    ),
    
    column(2,
      numericInput("nfx1", label=h4("No. affected #1"), 
        value=NA, min=0, max=Inf),
      numericInput("nfx2", label=h4("No. affected #2"), 
        value=NA, min=0, max=Inf),
      numericInput("nfx3", label=h4("No. affected #3"), 
        value=NA, min=0, max=Inf),
    ),
  ),
  
  h4("The Litchfield and Wilcoxon model fit to the data above, will be used to estimate the effective doses for percent effects (lethal concentrations) specified below"),
  
  fluidRow(
      numericInput("pa1", label=h4("LC #1"), 
        value=25, min=0.01, max=99.99),
      numericInput("pa2", label=h4("LC #2"), 
        value=50, min=0.01, max=99.99),
      numericInput("pa3", label=h4("LC #3"), 
        value=99.9, min=0.01, max=99.99),
  ),
  fluidRow(
    hr(),
    plotOutput("onePlot", inline=TRUE)
  ),
  fluidRow(
    hr(),
    h4("Scatter plot matrix (if multple lakes or metrics are selected)"),
    h5("Symbol color represents time, from farthest ago in light blue to most recent in dark blue."),
    plotOutput("pairsPlot", inline=TRUE),
    hr()
  )
)
```

Last modified: 25 April 2015  
Author: Jean V. Adams, [USGS - Great Lakes Science Center](http://www.glsc.usgs.gov/) and [Great Lakes Fishery Commission](http://www.GLFC.org/)

Created with: [R Shiny](http://shiny.rstudio.com/) by [Rstudio](http://www.rstudio.com/)  
